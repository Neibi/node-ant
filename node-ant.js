// Generated by CoffeeScript 1.6.3
(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d={}.hasOwnProperty,v=function(e,t){function r(){this.constructor=e}for(var n in t)d.call(t,n)&&(e[n]=t[n]);r.prototype=t.prototype;e.prototype=new r;e.__super__=t.prototype;return e},m=function(e,t){return function(){return e.apply(t,arguments)}};r=require("events").EventEmitter;t=function(e){function t(){this.MESSAGE_TX_SYNC=164;this.DEFAULT_NETWORK_NUMBER=0;this.MESSAGE_CHANNEL_UNASSIGN=65;this.MESSAGE_CHANNEL_ASSIGN=66;this.MESSAGE_CHANNEL_ID=81;this.MESSAGE_CHANNEL_PERIOD=67;this.MESSAGE_CHANNEL_SEARCH_TIMEOUT=68;this.MESSAGE_CHANNEL_FREQUENCY=69;this.MESSAGE_CHANNEL_TX_POWER=96;this.MESSAGE_NETWORK_KEY=70;this.MESSAGE_TX_POWER=71;this.MESSAGE_PROXIMITY_SEARCH=113;this.MESSAGE_STARTUP=111;this.MESSAGE_SYSTEM_RESET=74;this.MESSAGE_CHANNEL_OPEN=75;this.MESSAGE_CHANNEL_CLOSE=76;this.MESSAGE_CHANNEL_REQUEST=77;this.MESSAGE_CHANNEL_BROADCAST_DATA=78;this.MESSAGE_CHANNEL_ACKNOWLEDGED_DATA=79;this.MESSAGE_CHANNEL_BURST_DATA=80;this.MESSAGE_CHANNEL_EVENT=64;this.MESSAGE_CHANNEL_STATUS=82;this.MESSAGE_VERSION=62;this.MESSAGE_CAPABILITIES=84;this.MESSAGE_SERIAL_NUMBER=97;this.CHANNEL_TYPE_TWOWAY_RECEIVE=0;this.CHANNEL_TYPE_TWOWAY_TRANSMIT=16;this.CHANNEL_TYPE_SHARED_RECEIVE=32;this.CHANNEL_TYPE_SHARED_TRANSMIT=48;this.CHANNEL_TYPE_ONEWAY_RECEIVE=64;this.CHANNEL_TYPE_ONEWAY_TRANSMIT=80;this.RADIO_TX_POWER_MINUS20DB=0;this.RADIO_TX_POWER_MINUS10DB=1;this.RADIO_TX_POWER_0DB=2;this.RADIO_TX_POWER_PLUS4DB=3;this.RESPONSE_NO_ERROR=0;this.EVENT_RX_SEARCH_TIMEOUT=1;this.EVENT_RX_FAIL=2;this.EVENT_TX=3;this.EVENT_TRANSFER_RX_FAILED=4;this.EVENT_TRANSFER_TX_COMPLETED=5;this.EVENT_TRANSFER_TX_FAILED=6;this.EVENT_CHANNEL_CLOSED=7;this.EVENT_RX_FAIL_GO_TO_SEARCH=8;this.EVENT_CHANNEL_COLLISION=9;this.EVENT_TRANSFER_TX_START=10;this.CHANNEL_IN_WRONG_STATE=21;this.CHANNEL_NOT_OPENED=22;this.CHANNEL_ID_NOT_SET=24;this.CLOSE_ALL_CHANNELS=25;this.TRANSFER_IN_PROGRESS=31;this.TRANSFER_SEQUENCE_NUMBER_ERROR=32;this.TRANSFER_IN_ERROR=33;this.MESSAGE_SIZE_EXCEEDS_LIMIT=39;this.INVALID_MESSAGE=40;this.INVALID_NETWORK_NUMBER=41;this.INVALID_LIST_ID=48;this.INVALID_SCAN_TX_CHANNEL=49;this.INVALID_PARAMETER_PROVIDED=51;this.EVENT_QUEUE_OVERFLOW=53;this.USB_STRING_WRITE_FAIL=112;this.CHANNEL_STATE_UNASSIGNED=0;this.CHANNEL_STATE_ASSIGNED=1;this.CHANNEL_STATE_SEARCHING=2;this.CHANNEL_STATE_TRACKING=3;this.CAPABILITIES_NO_RECEIVE_CHANNELS=1;this.CAPABILITIES_NO_TRANSMIT_CHANNELS=2;this.CAPABILITIES_NO_RECEIVE_MESSAGES=4;this.CAPABILITIES_NO_TRANSMIT_MESSAGES=8;this.CAPABILITIES_NO_ACKNOWLEDGED_MESSAGES=16;this.CAPABILITIES_NO_BURST_MESSAGES=32;this.CAPABILITIES_NETWORK_ENABLED=2;this.CAPABILITIES_SERIAL_NUMBER_ENABLED=8;this.CAPABILITIES_PER_CHANNEL_TX_POWER_ENABLED=16;this.CAPABILITIES_LOW_PRIORITY_SEARCH_ENABLED=32;this.CAPABILITIES_SCRIPT_ENABLED=64;this.CAPABILITIES_SEARCH_LIST_ENABLED=128;this.CAPABILITIES_LED_ENABLED=1;this.CAPABILITIES_EXT_MESSAGE_ENABLED=2;this.CAPABILITIES_SCAN_MODE_ENABLED=4;this.CAPABILITIES_PROX_SEARCH_ENABLED=16;this.CAPABILITIES_EXT_ASSIGN_ENABLED=32;this.CAPABILITIES_FS_ANTFS_ENABLED=64;this.TIMEOUT_NEVER=255;this.POWER_PAGE_STANDARD_POWER_ONLY=16;this.POWER_PAGE_TORQUE_EFFECTIVENESS=19;this.POWER_PAGE_MANUFACTURER_INFO=80;this.POWER_PAGE_PRODUCT_INFO=81;this.POWER_PAGE_BATTERY_VOLTAGE=82;this.POWER_PAGE_CALIBRATION_REQUEST=1}v(t,e);return t}(r);u=function(e){function t(){this.getChecksum=m(this.getChecksum,this);this.decimalToHex=m(this.decimalToHex,this);this.intToLEHexArray=m(this.intToLEHexArray,this);this.buildMessage=m(this.buildMessage,this);this.unassignChannel=m(this.unassignChannel,this);this.closeChannel=m(this.closeChannel,this);this.openChannel=m(this.openChannel,this);this.setFrequency=m(this.setFrequency,this);this.setPeriod=m(this.setPeriod,this);this.searchChannel=m(this.searchChannel,this);this.setDevice=m(this.setDevice,this);this.assignChannel=m(this.assignChannel,this);this.setNetworkKey=m(this.setNetworkKey,this);this.requestMessage=m(this.requestMessage,this);this.resetSystem=m(this.resetSystem,this);t.__super__.constructor.call(this)}v(t,e);t.prototype.resetSystem=function(){var e;e=[];e.push(0);return this.buildMessage(e,this.MESSAGE_SYSTEM_RESET)};t.prototype.requestMessage=function(e){var t;e==null&&(e=0);t=[];t=t.concat(this.intToLEHexArray(e));t.push(this.MESSAGE_CAPABILITIES);return this.buildMessage(t,this.MESSAGE_CHANNEL_REQUEST)};t.prototype.setNetworkKey=function(){var e;e=[];e.push(this.DEFAULT_NETWORK_NUMBER);e.push(185);e.push(165);e.push(33);e.push(251);e.push(189);e.push(114);e.push(195);e.push(69);return this.buildMessage(e,this.MESSAGE_NETWORK_KEY)};t.prototype.assignChannel=function(e,t){var n;e==null&&(e=0);t==null&&(t="receive");n=[];n=n.concat(this.intToLEHexArray(e));t==="receive"?n.push(this.CHANNEL_TYPE_TWOWAY_RECEIVE):n.push(this.CHANNEL_TYPE_TWOWAY_TRANSMIT);n.push(this.DEFAULT_NETWORK_NUMBER);return this.buildMessage(n,this.MESSAGE_CHANNEL_ASSIGN)};t.prototype.setDevice=function(e,t,n,r){var i;e==null&&(e=0);t==null&&(t=0);n==null&&(n=0);r==null&&(r=0);i=[];i=i.concat(this.intToLEHexArray(e));i=i.concat(this.intToLEHexArray(t,2));i=i.concat(this.intToLEHexArray(n));i=i.concat(this.intToLEHexArray(r));return this.buildMessage(i,this.MESSAGE_CHANNEL_ID)};t.prototype.searchChannel=function(e,t){var n;e==null&&(e=0);t==null&&(t=0);n=[];n=n.concat(this.intToLEHexArray(e));n=n.concat(this.intToLEHexArray(t));return this.buildMessage(n,this.MESSAGE_CHANNEL_SEARCH_TIMEOUT)};t.prototype.setPeriod=function(e,t){var n;e==null&&(e=0);t==null&&(t=0);n=[];n=n.concat(this.intToLEHexArray(e));n=n.concat(this.intToLEHexArray(t));return this.buildMessage(n,this.MESSAGE_CHANNEL_PERIOD)};t.prototype.setFrequency=function(e,t){var n;e==null&&(e=0);t==null&&(t=0);n=[];n=n.concat(this.intToLEHexArray(e));n=n.concat(this.intToLEHexArray(t));return this.buildMessage(n,this.MESSAGE_CHANNEL_FREQUENCY)};t.prototype.openChannel=function(e){var t;e==null&&(e=0);t=[];t=t.concat(this.intToLEHexArray(e));return this.buildMessage(t,this.MESSAGE_CHANNEL_OPEN)};t.prototype.closeChannel=function(e){var t;e==null&&(e=0);t=[];t=t.concat(this.intToLEHexArray(e));return this.buildMessage(t,this.MESSAGE_CHANNEL_CLOSE)};t.prototype.unassignChannel=function(e){var t;e==null&&(e=0);t=[];t=t.concat(this.intToLEHexArray(e));return this.buildMessage(t,this.MESSAGE_CHANNEL_UNASSIGN)};t.prototype.buildMessage=function(e,t){var n,r,i,s;e==null&&(e=[]);t==null&&(t=0);r=[];r.push(this.MESSAGE_TX_SYNC);r.push(e.length);r.push(t);for(i=0,s=e.length;i<s;i++){n=e[i];r.push(n)}r.push(this.getChecksum(r));return new Buffer(r)};t.prototype.intToLEHexArray=function(e,t){var n,r,i;t=typeof t=="undefined"||t===null?t=1:t;n=[];r=new Buffer(this.decimalToHex(e,t*2),"hex");i=r.length-1;while(i>=0){n.push(r[i]);i--}return n};t.prototype.decimalToHex=function(e,t){var n;n=Number(e).toString(16);t=typeof t=="undefined"||t===null?t=2:t;while(n.length<t)n="0"+n;return n};t.prototype.getChecksum=function(e){var t,n,r,i;for(r=0,i=e.length;r<i;r++){t=e[r];n=(n^t)%255}return n};return t}(t);e=function(e){function t(){t.__super__.constructor.call(this);this.Driver=n;this.USB2Driver=c;this.GarminStick2=s;this.GarminStick3=o;this.Messages=u;this.Sensor=f;this.PowerSensor=a;this.VectorSensor=h;this.SpeedAndCadenceSensor=l;this.GarminSpeedAndCadenceSensor=i}v(t,e);return t}(t);p=require("usb");n=function(e){function t(){this.close=m(this.close,this);this.open=m(this.open,this);p.setDebugLevel(0)}v(t,e);t.prototype.open=function(){return console.log("This driver does not the open command")};t.prototype.close=function(){return console.log("This driver does not the close command")};return t}(t);c=function(e){function t(e,n){this.idVendor=e;this.idProduct=n;this.writeCallback=m(this.writeCallback,this);this.write=m(this.write,this);this.close=m(this.close,this);this.open=m(this.open,this);t.__super__.constructor.call(this);this.device=null;this.iface=null;this.inEndpoint=null;this.outEndpoint=null}v(t,e);t.prototype.open=function(){var e=this;this.device=p.findByIds(this.idVendor,this.idProduct);this.device.open();this.iface=this.device.interfaces[0];this.iface.claim();this.inEndpoint=this.iface.endpoints[0];this.inEndpoint.startStream(1,128);this.inEndpoint.on("data",function(t){return e.emit("read",t)});this.inEndpoint.on("error",function(e){return console.log(e)});this.inEndpoint.on("end",function(){return console.log("*****STOP RECIEVING*****")});return this.outEndpoint=this.iface.endpoints[1]};t.prototype.close=function(){};t.prototype.write=function(e){return this.outEndpoint.transfer(e,this.writeCallback)};t.prototype.writeCallback=function(e){if(e)return console.log(e)};return t}(n);s=function(e){function t(){t.__super__.constructor.call(this,4047,4104)}v(t,e);return t}(c);o=function(e){function t(){t.__super__.constructor.call(this,4047,4105)}v(t,e);return t}(c);f=function(e){function t(e){this.stick=e;this.emitStatus=m(this.emitStatus,this);this.handleEventMessages=m(this.handleEventMessages,this);this.detachAll=m(this.detachAll,this);this.attach=m(this.attach,this);t.__super__.constructor.call(this);this.stick.on("read",this.handleEventMessages)}v(t,e);t.prototype.attach=function(e,t,n,r,i,s,o,u){this.stick.write(this.resetSystem());this.stick.write(this.requestMessage(e));this.stick.write(this.setNetworkKey());this.stick.write(this.assignChannel(e,t));this.stick.write(this.setDevice(e,n,r,i));this.stick.write(this.searchChannel(e,s));this.stick.write(this.setPeriod(e,o));this.stick.write(this.setFrequency(e,u));return this.stick.write(this.openChannel(e))};t.prototype.detachAll=function(e){this.stick.write(this.closeChannel(e));this.stick.write(this.unassignChannel(e));return this.stick.write(this.resetSystem())};t.prototype.handleEventMessages=function(e){var t,n,r,i;if(e.readUInt8(2)===this.MESSAGE_CHANNEL_EVENT){if(e.length===7)return this.emitStatus(e);i=[];for(t=n=0,r=e.length;n<r;t=n+=7)i.push(this.emitStatus(new Buffer([e[t],e[t+1],e[t+2],e[t+3],e[t+4],e[t+5],e[t+6]],"hex")));return i}};t.prototype.emitStatus=function(e){var t,n;t=e.readUInt8(2);if(t===this.MESSAGE_CHANNEL_EVENT){n={desc:null,value:null};switch(e.readUInt8(4)){case this.MESSAGE_NETWORK_KEY:n.desc="network key set";n.value=!0;break;case this.MESSAGE_CHANNEL_ID:n.desc="channel ID set";n.value=!0;break;case this.MESSAGE_CHANNEL_SEARCH_TIMEOUT:n.desc="search timeout set";n.value=!0;break;case this.MESSAGE_CHANNEL_PERIOD:n.desc="channel period set";n.value=!0;break;case this.MESSAGE_CHANNEL_FREQUENCY:n.desc="frequency set";n.value=!0;break;case this.MESSAGE_CHANNEL_OPEN:n.desc="channel opened";n.value=!0;break;case this.MESSAGE_CHANNEL_CLOSE:n.desc="channel closed";n.value=!0;break;case this.MESSAGE_CHANNEL_UNASSIGN:n.desc="channel unassigned";n.value=!0}return this.emit("status",n)}};return t}(u);a=function(e){function t(e){this.stick=e;this.getPowerOnlyData=m(this.getPowerOnlyData,this);this.handleDataDecode=m(this.handleDataDecode,this);this.attach=m(this.attach,this);t.__super__.constructor.call(this,this.stick);this.stick.on("read",this.handleDataDecode)}v(t,e);t.prototype.attach=function(e,n){return t.__super__.attach.call(this,e,"receive",n,11,5,255,8182,57)};t.prototype.handleDataDecode=function(e){var t;if(e.readUInt8(1)>=8&&e.readUInt8(2)===this.MESSAGE_CHANNEL_BROADCAST_DATA)switch(e.readUInt8(4)){case this.POWER_PAGE_STANDARD_POWER_ONLY:t=this.getPowerOnlyData(e);return this.emit("powerdata",t)}};t.prototype.getPowerOnlyData=function(e){var t;t={};t.messagetype={name:"power",pagenumber:e.readUInt8(4)};t.eventcount=e.readUInt8(5);t.balance={};if(e.readUInt8(6)>>7&1){t.balance.side="right";t.balance.value=e.readUInt8(6)^128}else{t.balance.side="unknown";t.balance.value=e.readUInt8(6)}t.balance.unit={"long":"Percent","short":"%"};t.cadence={};switch(e.readUInt8(7)){case 255:t.cadence.value=null;break;default:t.cadence.value=e.readUInt8(7)}t.cadence.unit={"long":"Revolutions Per Minute","short":"RPM"};t.power={accumulated:e.readUInt16LE(8),instantaneous:e.readUInt16LE(10),unit:{"long":"Watt","short":"W"}};return t};return t}(f);h=function(e){function t(e){this.stick=e;this.attach=m(this.attach,this);t.__super__.constructor.call(this,this.stick)}v(t,e);t.prototype.attach=function(e,n){return t.__super__.attach.call(this,e,n)};return t}(a);l=function(e){function t(e){this.attach=m(this.attach,this);t.__super__.constructor.call(this,e)}v(t,e);t.prototype.attach=function(e,n){return t.__super__.attach.call(this,e,"receive",n,121,1,255,8086,57)};return t}(f);i=function(e){function t(e){this.attach=m(this.attach,this);t.__super__.constructor.call(this,e)}v(t,e);t.prototype.attach=function(e,n){return t.__super__.attach.call(this,e,n)};return t}(l);module.exports=new e}).call(this);